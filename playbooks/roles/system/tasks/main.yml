---
- name: Create the orai group
  group:
    name: "{{ _orai_validator_system_group }}"
    state: present
    system: true
  when: _orai_validator_system_group != "root"

- name: Create the orai user
  user:
    name: "{{ _orai_validator_system_user }}"
    group: "{{ _orai_validator_system_group }}"
    shell: /bin/bash
    create_home: true
    home: "{{ orai_HOME }}"
  when: _orai_validator_system_user != "root"

- name: Install gcc
  ansible.builtin.package:
    name: gcc
    state: present
- name: Prepare GO upgrade
  file:
    path: /usr/local/go
    state: absent
  tags:
    - remove_go
- name: Create go/bin directory
  ansible.builtin.file:
    path: "{{ oraid_binary_path }}"
    state: directory
    mode: '0755'
- name: Recursively change ownership of go/bin
  ansible.builtin.file:
    path: "{{ oraid_binary_path }}"
    state: directory
    recurse: yes
    owner: orai
    group: orai
- name: Download GO latest
  ansible.builtin.unarchive:
    src: https://go.dev/dl/go1.24.2.linux-amd64.tar.gz
    dest: /usr/local/
    remote_src: yes
  tags:
    - go_download
- name: Configure Oraid user environment
  blockinfile:
    path: "{{ orai_HOME | quote }}/.bashrc"
    block: |
      export GOROOT=/usr/local/go
      export GOPATH="{{ orai_HOME | quote}}/go"
      export GO111MODULE=on
      export PATH=$PATH:/usr/local/go/bin:"{{ oraid_binary_path | quote}}"
    backup: yes
  tags:
    - go_environment
- name: Configure Cosmovisor user environment
  blockinfile:
    path: "{{ orai_HOME | quote }}/.bashrc"
    block: |
      export ORAI_HOME="{{ orai_HOME | quote }}"
      export DAEMON_NAME=oraid
      export DAEMON_HOME="{{ oraid_HOME | quote }}"
      export DAEMON_ALLOW_DOWNLOAD_BINARIES=false
      export DAEMON_RESTART_AFTER_UPGRADE=true
      export UNSAFE_SKIP_BACKUP=true
    backup: yes
  tags:
    - cosmovisor_environment
- name: source "{{ orai_HOME | quote}}/.bashrc"
  shell: source "{{ orai_HOME | quote}}/.bashrc"
  args:
    executable: /bin/bash

